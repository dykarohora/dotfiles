##### ==== PATH & 基本環境 ==== #####

export PATH="$PATH:./node_modules/.bin"
export PATH="/opt/homebrew/opt/openjdk@21/bin:$PATH"
export PATH="/usr/local/smlnj/bin:$PATH"
export PATH="$HOME/.claude/local/claude:$PATH"
export PATH="/opt/homebrew/opt/libpq/bin:$PATH"

export KAGGLE_CONFIG_DIR="$HOME/kaggle-project/config"

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

# pnpm
export PNPM_HOME="$HOME/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac

# AWS
export AWS_PROFILE=admin

# history
export HISTFILE="$HOME/.zsh_history"
export HISTSIZE=10000
export SAVEHIST=10000

setopt EXTENDED_HISTORY
setopt SHARE_HISTORY
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_REDUCE_BLANKS
setopt INC_APPEND_HISTORY
setopt globdots

export EDITOR=nvim


##### ==== completion 用パス（fpath に統一） ==== #####

fpath=(
  $HOME/.docker/completions
  /opt/homebrew/share/zsh-completions
  /opt/homebrew/share/zsh/site-functions
  $fpath
)


##### ==== zsh-autocomplete（compinit 含む） ==== #####

# Homebrew で入れてる想定: brew install zsh-autocomplete
source /opt/homebrew/share/zsh-autocomplete/zsh-autocomplete.plugin.zsh

# 大文字小文字ゆるく無視
zstyle ':completion:*' matcher-list \
  'm:{a-z}={A-Z}' \
  'm:{a-zA-Z}={a-zA-Z} r:|[._-]=* r:|=*'

# 補完後に勝手にスペースを入れない（Tabサイクル時に単語が増殖しないように）
zstyle ':autocomplete:*' add-space

# --- Tab の流儀を zsh-autocomplete 公式スタイルで上書き --- 
# 1. コマンドライン上で Tab / Shift-Tab を押すと「メニュー」に入る
bindkey              '^I'         menu-select
bindkey "$terminfo[kcbt]" menu-select

# 2. メニューの中では Tab / Shift-Tab で候補サイクル
bindkey -M menuselect              '^I'         menu-complete
bindkey -M menuselect "$terminfo[kcbt]" reverse-menu-complete

# 3. メニュー中でも Enter でそのまま実行できるように（好みだけど便利）
bindkey -M menuselect '^M' .accept-line


##### ==== AWS CLI 補完（bashcompinit 経由） ==== #####

autoload -Uz bashcompinit
bashcompinit

# aws_completer の場所は `which aws_completer` で確認して必要なら修正
complete -C '/usr/local/bin/aws_completer' aws


##### ==== autosuggestions / syntax-highlighting ==== #####

source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh


##### ==== starship / mise / uv / zoxide / opam ==== #####

eval "$(starship init zsh)"
eval "$(~/.local/bin/mise activate zsh)"
eval "$(uv generate-shell-completion zsh)"

if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"

  alias cd='z'
  alias cdi='zi'
  alias cdb='z -'

  alias zz='z -'
  alias zh='z ~'
  alias zr='z /'

  alias zq='zoxide query'
  alias za='zoxide add'
  alias zrm='zoxide remove'
  alias zl='zoxide query -l'
fi

[[ ! -r "$HOME/.opam/opam-init/init.zsh" ]] || \
  source "$HOME/.opam/opam-init/init.zsh" > /dev/null 2> /dev/null


##### ==== fzf ==== #####

export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!**/.git/*"'
export FZF_DEFAULT_OPTS="
  --height 40% --reverse --border=sharp --margin=0,1
  --prompt=' ' --color=light
"

export FZF_CTRL_T_COMMAND='rg --files --hidden --follow --glob "!**/.git/*"'
export FZF_CTRL_T_OPTS="
  --preview 'bat --color=always --style=header,grid {}'
  --preview-window=right:60%
"

export FZF_CTRL_R_OPTS="
  --preview 'echo {}' --preview-window down:3:hidden:wrap --bind '?:toggle-preview'
"

[ -f "$HOME/.fzf.zsh" ] && source "$HOME/.fzf.zsh"


##### ==== alias / 関数 ==== #####

# eza
if command -v eza >/dev/null 2>&1; then
  alias ls='eza'
  alias ll='eza -laH'
  alias la='eza -a'
  alias l='eza -lH'

  alias tree='eza --tree'
  alias lt='eza --tree --level=2'
  alias llt='eza -la --tree --level=2'
  alias lg='eza -la --git'
fi

# claude
alias claude="$HOME/.claude/local/claude"

# Yazi
function y() {
  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
  yazi "$@" --cwd-file="$tmp"
  IFS= read -r -d '' cwd < "$tmp"
  [ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
  rm -f -- "$tmp"
}
